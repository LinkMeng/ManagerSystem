# 开发文档

本系统基于SpringBoot开发。本文将介绍本系统中涉及到的除接口和业务逻辑之外的主要模块。

# 一、日志

日志模块基于log4j2开发，配置文件为：`/src/main/resources/log4j2.xml`。

当前日志只有控制台输出，默认日志级别为INFO。

# 二、异常

异常模块的主要代码见：`com.linkmeng.managersystem.common.exception.*`。

本系统中共涉及三种自定义异常，分别为：

1. 通用异常（500） - CommonException
2. 参数校验异常（400） - InputIllegalException
3. 用户权限校验异常（403） - PermissionException

当异常从接口处抛出时，先通过全局异常处理器捕获，并在其中配合国际化模块对异常信息进行国际化，并最终给用户返回包含：异常信息（message）、异常详情（detail）和修复建议（suggestion）三个字段的异常报文。异常报文示例如下：

```json
{
  "message": "入参校验失败。",
  "detail": "入参“userResource.userId”不合法。",
  "suggestion": "请检查入参后重试。"
}
```

# 三、国际化

国际化配置文件位于：`/src/main/resources/i18n/`目录下；国际化工具类为：`com.linkmeng.managersystem.common.util.ResourceUtil`。

国际化包含两种，分别为：正常信息的国际化及异常信息的国际化。

## 3.1 正常信息

正常信息的国际化比较简单，当调用国际化方法时，只需要传入国际化Id及相应的参数，方法内会自动获取当前系统的语言配置，并拼接选择对应的国际化文件。

当前只支持两种语言：

1. 中文/中国（zh_CN）
2. 英文/美国（en_US）

当获取到的语言不是上述两种语言之一时，默认会回滚到中文/中国。

## 3.2 异常信息

异常信息的国际化与正常信息相似。不同的是，异常信息的国际化是在异常抛出后自动完成的。

当异常从接口抛出时，首先会被全局异常处理器拦截，此时会获取到异常抛出时填写的国际化Id，然后分别拼接上“.message”、“.detail”和“.suggestion”后缀后再调用国际化方法。

需要注意，只有从接口抛出的异常才会被国际化，在日志中打印到控制台的异常，除非进行手动国际化，否则控制台中打印的异常信息仍是国际化Id。

# 四、权限校验

权限校验模块使用自定义注解配合切面实现，核心逻辑为：`com.linkmeng.managersystem.role.*`。

通过在接口上使用自定义注解`@RequiredUserRole({})`来定义该接口允许具有哪些权限的用户访问。Header中的用户信息在切面中被解析并与配置进行对比，如果获取不到用户信息或当前用户无权限，则会抛出用户权限校验异常。

同时，切面还会将解析后的用户信息赋值给接口中使用注解`@RoleUserInfo`标记的形参，方便业务逻辑使用，而无需再在每个接口处都重新解析用户信息。

# 五、缓存

由于本系统使用文件代替数据库进行数据持久化，因此需要缓存模块以在可能的高并发状态下尽可能降低磁盘IO。缓存模块的核心逻辑见：`com.linkmeng.managersystem.common.cache.*`。

缓存中定义了持久化文件名、缓存失效时间等配置项，所有涉及到缓存写与文件读写的操作均已上锁。

## 5.1 写入

当业务逻辑执行缓存写入时，数据会被直接写入到缓存中，并更新缓存的修改日期。

1. 如果单词写入后超过缓存失效时间仍没有下一次写入，则会将当前缓存中的数据写入持久化文件中；
2. 如果在缓存失效时间内持续有数据写入，则数据会一直在缓存中，直到写入停止并且缓存再次失效后才会写入持久化文件。

缓存在写入时，会同时为每条记录额外添加一个“更新时间”字段，以便在读取时对缓存和文件内容进行合并。

## 5.2 读取

当业务逻辑执行缓存读取时，会首先检查缓存是否已经超时。

1. 如果缓存还未超时，则直接在缓存中取到目标值并返回；
2. 如果缓存已经超时，则会先读取持久化文件，然后对文件和当前缓存中每一条记录的“更新时间”字段进行一一比对，且只保留更新的数据。
